
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="last-modified" content="2016-10-30T14:20:37.2462124+00:00" />
    <meta name="keywords" content="" />


    <title>Entity Framework Core 1.0.1 Migrations in Separate Assembly - Michael Whelan - behaviour driven blog</title>

    <link href="/stylesheets/bootstrap.css" rel="stylesheet">
    <link href="/stylesheets/font-awesome/css/font-awesome.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/stylesheets/github.css" type="text/css">
    <link rel="stylesheet" href="/stylesheets/styles.css" type="text/css" />

    <link rel="canonical" href="http://www.michael-whelan.net/ef-core-101-migrations-in-separate-assembly/" />
</head>
<body>
    <div class="container">
        <!-- row 1: navigation -->
        <div class="row">
            <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="navigation">
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="http://michael-whelan.net/">behaviour driven blog</a>
                    </div>
                    <div class="collapse navbar-collapse" id="collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="http://about.me/michaelwhelan">About</a></li>
                            <li class="dropdown">
                                <a href="#" data-toggle="dropdown">Categories <span class="caret"></span></a>
                                <ul class="dropdown-menu">
                                        <li>
                                            <a href="/category/automated-testing" title="Automated Testing">Automated Testing</a>
                                        </li>
                                        <li>
                                            <a href="/category/azure" title="Azure">Azure</a>
                                        </li>
                                        <li>
                                            <a href="/category/bdd" title="BDD">BDD</a>
                                        </li>
                                        <li>
                                            <a href="/category/bddfy" title="BDDfy">BDDfy</a>
                                        </li>
                                        <li>
                                            <a href="/category/black-box-testing-asp.net-series" title="Black-Box Testing ASP.Net Series">Black-Box Testing ASP.Net Series</a>
                                        </li>
                                        <li>
                                            <a href="/category/dotnet-core" title="DotNet Core">DotNet Core</a>
                                        </li>
                                        <li>
                                            <a href="/category/general" title="General">General</a>
                                        </li>
                                        <li>
                                            <a href="/category/learning" title="Learning">Learning</a>
                                        </li>
                                        <li>
                                            <a href="/category/programming" title="Programming">Programming</a>
                                        </li>
                                        <li>
                                            <a href="/category/seleno" title="Seleno">Seleno</a>
                                        </li>
                                        <li>
                                            <a href="/category/snow" title="Snow">Snow</a>
                                        </li>
                                        <li>
                                            <a href="/category/sql-server" title="SQL Server">SQL Server</a>
                                        </li>
                                        <li>
                                            <a href="/category/test-data" title="Test Data">Test Data</a>
                                        </li>
                                        <li>
                                            <a href="/category/teststack" title="TestStack">TestStack</a>
                                        </li>
                                        <li>
                                            <a href="/category/visual-studio" title="Visual Studio">Visual Studio</a>
                                        </li>
                                </ul>
                            </li>
                            <li><a href="/archive">Archive</a></li>
                            <li><a href="/feed.xml">RSS</a></li>
                        </ul>

                        <div class="navbar-right">
                            <a class="navbar-custom-button" href="https://twitter.com/mjmwhelan" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="/stylesheets/images/twitter.png"></a>
                            <a class="navbar-custom-button" href="https://github.com/mwhelan" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://github.com']);"><img src="/stylesheets/images/github.png"></a>
                            <a class="navbar-custom-button" href="http://www.linkedin.com/in/mwhelan" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://www.linkedin.com']);"><img src="/stylesheets/images/linkedin.png"></a>
                            <a class="navbar-custom-button" href="https://plus.google.com/u/1/105055485720815974241?rel=me" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://plus.google.com']);"><img src="/stylesheets/images/googleplus.png"></a>
                        </div>
                    </div><!--collapse -->
                </div>
            </nav>
        </div><!--row -->
        <!-- row 2: header -->
        <header class="row">
            <a href="/" title="Home"><img width="60" height="60" src="http://www.gravatar.com/avatar/391e4f217a06e3dfc8976a4b99b79617.png" title="logo"></a>
            <h1 class="blog-title">
                <a href="/" title="Michael Whelan" rel="home">Michael Whelan</a>
            </h1>
            <p class="lead blog-description">behaviour driven blog</p>
        </header>

        <!-- row 3: featured -->
        <div class="row">
            
        </div>

        <!-- row 4: body -->
        <div class="row">
            

<div id="post">
    <h1 class="blog-post-title">Entity Framework Core 1.0.1 Migrations in Separate Assembly</h1>

    <div class="blog-post-meta">
        posted on 30 Oct 2016
            | <a class="label label-primary" href="/category/dotnet-core">DotNet Core</a>
    </div>

    <div class="blog-post">
        

        <p>I am getting to grips with Entity Framework Core at the moment and I like what I am seeing so far. There are still a few EF6 scenarios that are not supported yet but the main use cases are supported and there are often workarounds for those that aren't. Entity Framework 1.1 is out soon and features will continue to be added as things just continue to improve. I love the strategic direction the project has taken and, <a href="https://channel9.msdn.com/Shows/On-NET/Rowan-Miller-Entity-Framework-Core-11">listening to the team discuss the new design</a>, the modular approach and use of dependency injection seems far better, not to mention the massive performance improvements they are already seeing. </p>

<p>When building ASP.Net MVC applications it is quite common to want to store your domain model and data access code in separate class libraries. If this is the case, then ideally you would not even want a reference to Entity Framework Core in your ASP.Net MVC Core project. In this post, I am going to look at how this can be achieved today with the current .Net Core 1.0.1 versions of MVC and EF. </p>

<!--excerpt-->

<h2>Contoso University ASP.Net MVC Core Sample</h2>

<p>I have implemented the <a href="https://docs.asp.net/en/latest/data/ef-mvc/intro.html">first</a> and <a href="https://docs.asp.net/en/latest/data/ef-mvc/migrations.html">fourth</a> tutorials of the Contoso sample, which wire up a view to the database and implement migrations in an ASP.Net MVC project, and then migrated the domain model and Entity Framework code to a separate class library. There are no Entity Framework references in the ContosoUniversity MVC project and, instead, the EF dependency is just injected at runtime. You can see the source code on <a href="https://github.com/mwhelan/MvcEfCore10Sample">GitHub</a>.</p>

<p><img src="/images/ef-core-solution.png" alt="VS solution" /></p>

<p>Credit where it is due, I have provided an updated version of solutions from <a href="http://benjii.me/2016/06/entity-framework-core-migrations-for-class-library-projects/">Ben Cull</a> and the <a href="https://docs.efproject.net/en/latest/miscellaneous/cli/dotnet.html#preview-2-known-issues">EF docs</a>. </p>

<h2>Step 1: Configure the class library as an application</h2>

<pre><code>{
  "version": "1.0.0-*",

  "buildOptions": {
    "emitEntryPoint": true
  },

  "frameworks": {
    "netcoreapp1.0": {
      "dependencies": {
        "Microsoft.NETCore.App": {
          "version": "1.0.1",
          "type": "platform"
        }
      }
    }
  },

  "dependencies": {
    "Microsoft.EntityFrameworkCore.SqlServer": "1.0.1",
    "Microsoft.EntityFrameworkCore.SqlServer.Design": {
      "version": "1.0.1",
      "type": "build"
    },
    "Microsoft.EntityFrameworkCore.Tools": {
      "version": "1.0.0-preview2-final",
      "type": "build"
    }
  },

  "tools": {
    "Microsoft.EntityFrameworkCore.Tools": "1.0.0-preview2-final"
  }
}
</code></pre>

<p>To convert the class library to a .Net Core application, you have to add the <code>frameworks</code> section above. It is also important that you add a reference to 
<code>Microsoft.EntityFrameworkCore.Tools</code> in the <code>dependencies</code> and <code>tools</code> sections. </p>

<h2>Step 2: Add static void Main</h2>

<p>Because this is an application you need to add a <code>Program.cs</code> file to serve as an entry point.</p>

<pre><code>public class Program
{
    public static void Main(string[] args)
    {
    }
}
</code></pre>

<h2>Step 3: Create a DB Context Factory</h2>

<p>The CLI tools would normally discover the DbContext configuration in the Startup.cs of the web application, but the same thing can be achieved by creating a class that implements the IDbContextFactory interface. </p>

<pre><code>public class SchoolDbContextFactory : IDbContextFactory&lt;SchoolContext&gt;
{
    public SchoolContext Create(DbContextFactoryOptions options)
    {
        var builder = new DbContextOptionsBuilder&lt;SchoolContext&gt;();
        builder.UseSqlServer(
            "Server=(localdb)\\mssqllocaldb;Database=MyContosoUniversityCoreDb;Trusted_Connection=True;MultipleActiveResultSets=true");
        return new SchoolContext(builder.Options);
    }
}
</code></pre>

<h2>Step 4: Configure dependencies with extension methods on IApplicationBuilder and IServiceCollection</h2>

<p>There is still one last issue to solve before we can remove the dependency on EF Core from the ASP.Net MVC Core project. The <code>AddDbContext</code> extension method that configures EF Core in Startup.cs still requires a reference to the NuGet package.</p>

<pre><code>services.AddDbContext&lt;SchoolContext&gt;(options =&gt; 
    options.UseSqlServer(connectionString));
</code></pre>

<p>While most of the samples show how to configure dependencies in Startup.cs, this can quickly become quite unwieldy. I like <a href="http://odetocode.com/blogs/scott/archive/2016/08/30/keeping-a-clean-startup-cs-in-asp-net-core.aspx">Scott Allen's suggestion</a> of moving this configuration code into extension methods on IApplicationBuilder and IServiceCollection.</p>

<pre><code>public static class ServiceCollectionExtensions
{
    public static void AddEntityFramework(this IServiceCollection services, string connectionString)
    {
        services.AddDbContext&lt;SchoolContext&gt;(options =&gt;
                options.UseSqlServer(connectionString));
    }
}
</code></pre>

<p>I like this approach, because it simplifies Startup.cs to a series of self-documenting, one-line commands, and moves the EF configuration code where it belongs - next to all the other EF code.</p>

<h2>Running Migrations for the Class Library</h2>

<p>One important point to make, in case it is not obvious, is that you need to run migrations from the class library folder (and not from the web project folder).</p>

<p><img src="/images/ef-core-dotnet-ef-migrations-add.png" alt="VS test runner" /></p>

<h2>Summary</h2>

<p>When building ASP.Net MVC applications it is quite common to want to store your domain model and data access code in separate class libraries. If this is the case, then ideally you would not even want a reference to Entity Framework Core in your ASP.Net MVC Core project. In this post, I have shown how this can be achieved today with the current .Net Core 1.0.1 versions of MVC and EF. You can see the source code on <a href="https://github.com/mwhelan/MvcEfCore10Sample">GitHub</a>.</p>

    </div>
    
    <div class="blog-post aboutFooter">
        <h3>About Michael Whelan</h3>
        <img style="float:left;padding-right: 1em;" src="http://www.gravatar.com/avatar/391e4f217a06e3dfc8976a4b99b79617.png">
        <p>
            Michael Whelan is a software developer with 20 years’ experience in building (and testing!) applications on the Microsoft stack. He is passionate about applying agile development practices, such as TDD and BDD, to agile processes. Michael specializes in ASP.Net MVC but has also worked with WPF. He does open source development with <a href="http://www.teststack.net/">TestStack</a> to learn from great developers. Michael is a Principal Consultant at <a href="http://www.bjss.com/">BJSS</a> in London.
        </p>
    </div>
    
    <!-- Add this toolbox-->
    <div class="row addThis">
        <div class="addthis_toolbox addthis_default_style row pull-right" style="margin:10px">
            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
            <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
            <a class="addthis_button_linkedin_counter"></a>
            <a class="addthis_counter addthis_pill_style"></a>
        </div>
    </div>
    
    <!-- Disqus Comments -->
    <div class="row">
        <div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://www.michael-whelan.net/ef-core-101-migrations-in-separate-assembly/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'givenwhenthen';
    var disqus_url = 'http://www.michael-whelan.net/ef-core-101-migrations-in-separate-assembly/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>        
    </div>
    
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53d54a0e28fe9235"></script>

    <!-- Authorship Google -->
    <a style="display: block; width: 30px; height: 30px; text-indent: -999px; text-decoration: none" href="https://plus.google.com/u/1/105055485720815974241?rel=author">Google</a>
</div>

        </div>

        <hr>

        <footer class="row">
            <p>&copy; 2014 - Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a>.</p>
        </footer>
    </div> <!-- /container -->
    <script src="//code.jquery.com/jquery.js"></script>
    <script src="/javascripts/bootstrap.min.js"></script>
    <script src="/javascripts/prettify.js"></script>

    <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-49651944-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>

<script type='text/javascript'>
        $(function () {
            $("pre code").parent().each(function () {
                if (!$(this).hasClass("prettyprint")) {
                    $(this).addClass("prettyprint");
                    a = true
                }
            });

            prettyPrint();
        });
    </script>
    

    
    <!-- Authorship Google -->
    <a style="display: block; width: 30px; height: 30px; text-indent: -999px; text-decoration: none" href="https://plus.google.com/u/1/105055485720815974241?rel=author">Google</a>
</body>
</html>
