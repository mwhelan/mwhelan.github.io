
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="last-modified" content="2016-08-31T22:04:52.6715938+01:00" />
    <meta name="keywords" content="" />


    <title>Black-Box Testing ASP.Net: IIS Express and Selenium WebDriver - Michael Whelan - behaviour driven blog</title>

    <link href="/stylesheets/bootstrap.css" rel="stylesheet">
    <link href="/stylesheets/font-awesome/css/font-awesome.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/stylesheets/github.css" type="text/css">
    <link rel="stylesheet" href="/stylesheets/styles.css" type="text/css" />

    <link rel="canonical" href="http://www.michael-whelan.net/testing-mvc-application-with-iis-express-webdriver/" />
</head>
<body>
    <div class="container">
        <!-- row 1: navigation -->
        <div class="row">
            <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="navigation">
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="http://michael-whelan.net/">behaviour driven blog</a>
                    </div>
                    <div class="collapse navbar-collapse" id="collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="http://about.me/michaelwhelan">About</a></li>
                            <li class="dropdown">
                                <a href="#" data-toggle="dropdown">Categories <span class="caret"></span></a>
                                <ul class="dropdown-menu">
                                        <li>
                                            <a href="/category/automated-testing" title="Automated Testing">Automated Testing</a>
                                        </li>
                                        <li>
                                            <a href="/category/azure" title="Azure">Azure</a>
                                        </li>
                                        <li>
                                            <a href="/category/bdd" title="BDD">BDD</a>
                                        </li>
                                        <li>
                                            <a href="/category/bddfy" title="BDDfy">BDDfy</a>
                                        </li>
                                        <li>
                                            <a href="/category/black-box-testing-asp.net-series" title="Black-Box Testing ASP.Net Series">Black-Box Testing ASP.Net Series</a>
                                        </li>
                                        <li>
                                            <a href="/category/dotnet-core" title="DotNet Core">DotNet Core</a>
                                        </li>
                                        <li>
                                            <a href="/category/general" title="General">General</a>
                                        </li>
                                        <li>
                                            <a href="/category/learning" title="Learning">Learning</a>
                                        </li>
                                        <li>
                                            <a href="/category/programming" title="Programming">Programming</a>
                                        </li>
                                        <li>
                                            <a href="/category/seleno" title="Seleno">Seleno</a>
                                        </li>
                                        <li>
                                            <a href="/category/snow" title="Snow">Snow</a>
                                        </li>
                                        <li>
                                            <a href="/category/sql-server" title="SQL Server">SQL Server</a>
                                        </li>
                                        <li>
                                            <a href="/category/test-data" title="Test Data">Test Data</a>
                                        </li>
                                        <li>
                                            <a href="/category/teststack" title="TestStack">TestStack</a>
                                        </li>
                                        <li>
                                            <a href="/category/visual-studio" title="Visual Studio">Visual Studio</a>
                                        </li>
                                </ul>
                            </li>
                            <li><a href="/archive">Archive</a></li>
                            <li><a href="/feed.xml">RSS</a></li>
                        </ul>

                        <div class="navbar-right">
                            <a class="navbar-custom-button" href="https://twitter.com/mjmwhelan" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="/stylesheets/images/twitter.png"></a>
                            <a class="navbar-custom-button" href="https://github.com/mwhelan" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://github.com']);"><img src="/stylesheets/images/github.png"></a>
                            <a class="navbar-custom-button" href="http://www.linkedin.com/in/mwhelan" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://www.linkedin.com']);"><img src="/stylesheets/images/linkedin.png"></a>
                            <a class="navbar-custom-button" href="https://plus.google.com/u/1/105055485720815974241?rel=me" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://plus.google.com']);"><img src="/stylesheets/images/googleplus.png"></a>
                        </div>
                    </div><!--collapse -->
                </div>
            </nav>
        </div><!--row -->
        <!-- row 2: header -->
        <header class="row">
            <a href="/" title="Home"><img width="60" height="60" src="http://www.gravatar.com/avatar/391e4f217a06e3dfc8976a4b99b79617.png" title="logo"></a>
            <h1 class="blog-title">
                <a href="/" title="Michael Whelan" rel="home">Michael Whelan</a>
            </h1>
            <p class="lead blog-description">behaviour driven blog</p>
        </header>

        <!-- row 3: featured -->
        <div class="row">
            
        </div>

        <!-- row 4: body -->
        <div class="row">
            

<div id="post">
    <h1 class="blog-post-title">Black-Box Testing ASP.Net: IIS Express and Selenium WebDriver</h1>

    <div class="blog-post-meta">
        posted on 27 Oct 2014
            | <a class="label label-primary" href="/category/automated-testing">Automated Testing</a>
            | <a class="label label-primary" href="/category/black-box-testing-asp.net-series">Black-Box Testing ASP.Net Series</a>
    </div>

    <div class="blog-post">
        

        <p>In the next couple of posts I am going to look at some of the practical aspects of performing black-box testing of ASP.Net web applications with Selenium WebDriver. Most types of Visual Studio tests conveniently run in the same process as the code they are testing - the System Under Test (SUT). These are <a href="http://en.wikipedia.org/wiki/White-box_testing">white-box tests</a>, making it straightforward to change the behaviour and configuration of the SUT. <a href="http://en.wikipedia.org/wiki/Black-box_testing">Black-box tests</a>, such as UI tests, run in a separate process from the SUT, creating additional complexities for controlling its behaviour and configuration. In these posts, I'm going to focus less on concepts and more on the code.  </p>

<!--excerpt-->

<blockquote>
  <p>Some of the sample code is taken straight from <a href="https://github.com/TestStack/TestStack.Seleno">Seleno</a>, the Selenium WebDriver browser automation framework from <a href="http://teststack.net/">TestStack</a>, and gives you a look under the hood at the sorts of things a UI automation framework does for you. If some of these samples are relevant to the problems you are trying to solve, I encourage you to check out Seleno. It takes care of a lot of the complex infrastructure setup of a Selenium WebDriver project for you, allowing you to get on with the important business of writing specifications for your application. I've produced a working sample on <a href="https://github.com/mwhelan/MvcTestingSamples">GitHub</a>, so you should be able to take it, run it, and use some of the code in your own applications if you want to.</p>
</blockquote>

<h2>Managing the AppDomain</h2>

<p>One thing I try to avoid with UI tests is creating a new WebDriver instance for every test or test fixture. This is a time consuming operation and I find it is best to perform slow, expensive operations once before any tests run, then clean up after all of the tests have run. NUnit, which I'm using in these examples, provides the SetUpFixture for this purpose. (You can achieve the same effect in xUnit, and other frameworks that don't provide this feature, by using a static constructor in a base class, and subscribing to the AppDomain DomainUnload event).</p>

<pre><code>[SetUpFixture]
public class Host
{
    public static IisExpressWebServer WebServer;
    public static IWebDriver Browser;

    [SetUp]
    public void SetUp()
    {
        var app = new WebApplication(ProjectLocation.FromFolder("ContosoUniversity"), 12365);
        WebServer = new IisExpressWebServer(app);
        WebServer.Start();

        Browser = new FirefoxDriver();
    }

    [TearDown]
    public void TearDown()
    {
        Browser.Quit();
        WebServer.Stop();
    }
}
</code></pre>

<h2>Hosting your application in IIS Express</h2>

<p>To host an MVC application in IIS Express, you need to create a new Process for IIS Express, passing in the path to the folder that stores the web application project file (<code>.csproj</code> or <code>.vbproj</code> file) and the port number as arguments. This class wraps the creation of the IIS Express process and provides methods to start and stop the process.</p>

<pre><code>public class IisExpressWebServer 
{
    private static WebApplication _application;
    private static Process _webHostProcess;

    public IisExpressWebServer(WebApplication application)
    {
        if (application == null)
            throw new ArgumentNullException("The web application must be set.");
        _application = application;
    }

    public void Start()
    {
        var webHostStartInfo = InitializeIisExpress(_application);
        _webHostProcess = Process.Start(webHostStartInfo);
        _webHostProcess.TieLifecycleToParentProcess();
    }

    public void Stop()
    {
        if (_webHostProcess == null)
            return;
        if (!_webHostProcess.HasExited)
            _webHostProcess.Kill();
        _webHostProcess.Dispose();
    }

    public string BaseUrl
    {
        get { return string.Format("http://localhost:{0}", _application.PortNumber); }
    }

    private static ProcessStartInfo InitializeIisExpress(WebApplication application)
    {
        // todo: grab stdout and/or stderr for logging purposes?
        var key = Environment.Is64BitOperatingSystem ? "programfiles(x86)" : "programfiles";
        var programfiles = Environment.GetEnvironmentVariable(key);

        var startInfo = new ProcessStartInfo
        {
            WindowStyle = ProcessWindowStyle.Normal,
            ErrorDialog = true,
            LoadUserProfile = true,
            CreateNoWindow = false,
            UseShellExecute = false,
            Arguments = String.Format("/path:\"{0}\" /port:{1}", application.Location.FullPath, application.PortNumber),
            FileName = string.Format("{0}\\IIS Express\\iisexpress.exe", programfiles)
        };

        foreach (var variable in application.EnvironmentVariables)
            startInfo.EnvironmentVariables.Add(variable.Key, variable.Value);

        return startInfo;
    }
}
</code></pre>

<p>When the Start() method is called, a command window pops up showing the application running in IIS Express at the specified port number:</p>

<p><img src="/images/testing-mvc-iis-express-window.png" alt="IIS Express window" /></p>

<h2>Debugging the IIS Process</h2>

<p>If you set a breakpoint in your web application, and try to step into it from your test code, then you are going to be disappointed! Thankfully, it is quite simple to attach the debugger to the IIS Express process. Place a breakpoint in your test code after IIS Express has been spun up, then from the Visual Studio menu select</p>

<pre><code>Debug &gt; Attach to Process
</code></pre>

<p><img src="/images/testing-mvc-attach-debugger.png" alt="Attach to debugger" /></p>

<p>Scroll through the list of processes until you see <code>iisexpress.exe</code>. Note that the title is <code>IISExpress -</code>. This is the same as the title in the command window shown above. Select this process, and click <code>Attach</code>. Now  you can step through all of the code in your web application from your tests.</p>

<p>This is a slightly painful manual process. If you find this suitably irritating, it seems it is possible to <a href="http://stackoverflow.com/questions/19658269/visual-studio-attach-to-managed-process-programatically">automate it</a>.</p>

<h2>Closing Orphan Processes</h2>

<p><img src="/images/testing-mvc-stop-debugging.png" alt="stopping debugger" /></p>

<p>One thing that is very annoying about WebDriver testing is that when you stop debugging manually, or your test run crashes on the build server, the nice graceful shut down that you programmed in the AppDomain unload event does not fire. This leaves all of the child processes created during the test run - the browser, the various browser driver server windows, and the IIS process window -  open, and you have to manually close each one yourself. Not only that, but if you don't notice to shut them down and start another test run, then you get unpredictable results and have to stop that one too. </p>

<p>Fortunately, there is an easy solution. My friend and colleague, Jonathan Holford, found some wonderful code on stackoverflow that magically closes all of these orphan processes for you. Thankfully, he has packaged it up into a NuGet package, called <a href="https://www.nuget.org/packages/AllForOne">AllForOne</a>. According to the GitHub project page:</p>

<blockquote>
  <p>AllForOne uses Job Object voodoo to ensure a set of processes are managed as a unit. </p>
</blockquote>

<p>To use AllForOne, just call the <code>TieLifecycleToParentProcess</code> extension method on the child process. You can see this demonstrated in the <code>Start</code> method of the <code>IisExpressWebServer</code> above.</p>

<p>Most of the WebDriver browser drivers have a server implementation. Whilst you don't have direct control over the processes they start, you can still grab the process by its name and use the <code>TieLifecycleToParentProcess</code> method in the same way, and have the process closed down however the tests are stopped. Don't quote me on this, but I've found that the process name is the name of the executable without the extension.</p>

<pre><code>public static class Browsers
{
    private static RemoteWebDriver _phantom;
    public static RemoteWebDriver Phantom
    {
        get
        {
            if (_phantom == null)
            {
                _phantom = new PhantomJSDriver();
                var process = Process.GetProcessesByName("phantomjs").FirstOrDefault();
                process.TieLifecycleToParentProcess();
            }
            return _phantom;
        }
    }
}
</code></pre>

<h2>Finding the Project file</h2>

<p>This helper class encapsulates finding the path to the web project folder. It searches up from the current directory to find the .sln file, then searches all the directories below that to find the specified web project folder.</p>

<pre><code>public class ProjectLocation : IProjectLocation
{
    public string FullPath { get; private set; }

    private ProjectLocation(string fullPath)
    {
        var folder = new DirectoryInfo(fullPath);
        if (!folder.Exists)
        {
            throw new DirectoryNotFoundException();
        }
        FullPath = fullPath;
    }

    public static ProjectLocation FromPath(string webProjectFullPath)
    {
        return new ProjectLocation(webProjectFullPath);
    }

    public static ProjectLocation FromFolder(string webProjectFolderName)
    {
        string solutionFolder = GetSolutionFolderPath();
        string projectPath = FindSubFolderPath(solutionFolder, webProjectFolderName);
        return new ProjectLocation(projectPath);
    }

    private static string GetSolutionFolderPath()
    {
        var directory = new DirectoryInfo(Environment.CurrentDirectory);

        while (directory.GetFiles("*.sln").Length == 0)
        {
            directory = directory.Parent;
        }
        return directory.FullName;
    }

    private static string FindSubFolderPath(string rootFolderPath, string folderName)
    {
        var directory = new DirectoryInfo(rootFolderPath);

        directory = (directory.GetDirectories("*", SearchOption.AllDirectories)
            .Where(folder =&gt; folder.Name.ToLower() == folderName.ToLower()))
            .FirstOrDefault();

        if (directory == null)
        {
            throw new DirectoryNotFoundException();
        }

        return directory.FullName;
    }
}
</code></pre>

    </div>
    
    <div class="blog-post aboutFooter">
        <h3>About Michael Whelan</h3>
        <img style="float:left;padding-right: 1em;" src="http://www.gravatar.com/avatar/391e4f217a06e3dfc8976a4b99b79617.png">
        <p>
            Michael Whelan is a software developer with 20 yearsâ€™ experience in building (and testing!) applications on the Microsoft stack. He is passionate about applying agile development practices, such as TDD and BDD, to agile processes. Michael specializes in ASP.Net MVC but has also worked with WPF. He does open source development with <a href="http://www.teststack.net/">TestStack</a> to learn from great developers. Michael is a Principal Consultant at <a href="http://www.bjss.com/">BJSS</a> in London.
        </p>
    </div>
    
    <!-- Add this toolbox-->
    <div class="row addThis">
        <div class="addthis_toolbox addthis_default_style row pull-right" style="margin:10px">
            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
            <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
            <a class="addthis_button_linkedin_counter"></a>
            <a class="addthis_counter addthis_pill_style"></a>
        </div>
    </div>
    
    <!-- Disqus Comments -->
    <div class="row">
        <div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://www.michael-whelan.net/testing-mvc-application-with-iis-express-webdriver/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'givenwhenthen';
    var disqus_url = 'http://www.michael-whelan.net/testing-mvc-application-with-iis-express-webdriver/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>        
    </div>
    
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53d54a0e28fe9235"></script>

    <!-- Authorship Google -->
    <a style="display: block; width: 30px; height: 30px; text-indent: -999px; text-decoration: none" href="https://plus.google.com/u/1/105055485720815974241?rel=author">Google</a>
</div>

        </div>

        <hr>

        <footer class="row">
            <p>&copy; 2014 - Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a>.</p>
        </footer>
    </div> <!-- /container -->
    <script src="//code.jquery.com/jquery.js"></script>
    <script src="/javascripts/bootstrap.min.js"></script>
    <script src="/javascripts/prettify.js"></script>

    <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-49651944-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>

<script type='text/javascript'>
        $(function () {
            $("pre code").parent().each(function () {
                if (!$(this).hasClass("prettyprint")) {
                    $(this).addClass("prettyprint");
                    a = true
                }
            });

            prettyPrint();
        });
    </script>
    

    
    <!-- Authorship Google -->
    <a style="display: block; width: 30px; height: 30px; text-indent: -999px; text-decoration: none" href="https://plus.google.com/u/1/105055485720815974241?rel=author">Google</a>
</body>
</html>
