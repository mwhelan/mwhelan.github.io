
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="last-modified" content="2016-08-31T22:04:52.6715938+01:00" />
    <meta name="keywords" content="" />


    <title>Testing DateTime - Michael Whelan - behaviour driven blog</title>

    <link href="/stylesheets/bootstrap.css" rel="stylesheet">
    <link href="/stylesheets/font-awesome/css/font-awesome.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/stylesheets/github.css" type="text/css">
    <link rel="stylesheet" href="/stylesheets/styles.css" type="text/css" />

    <link rel="canonical" href="http://www.michael-whelan.net/testing-date-time/" />
</head>
<body>
    <div class="container">
        <!-- row 1: navigation -->
        <div class="row">
            <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="navigation">
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="http://michael-whelan.net/">behaviour driven blog</a>
                    </div>
                    <div class="collapse navbar-collapse" id="collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="http://about.me/michaelwhelan">About</a></li>
                            <li class="dropdown">
                                <a href="#" data-toggle="dropdown">Categories <span class="caret"></span></a>
                                <ul class="dropdown-menu">
                                        <li>
                                            <a href="/category/automated-testing" title="Automated Testing">Automated Testing</a>
                                        </li>
                                        <li>
                                            <a href="/category/azure" title="Azure">Azure</a>
                                        </li>
                                        <li>
                                            <a href="/category/bdd" title="BDD">BDD</a>
                                        </li>
                                        <li>
                                            <a href="/category/bddfy" title="BDDfy">BDDfy</a>
                                        </li>
                                        <li>
                                            <a href="/category/black-box-testing-asp.net-series" title="Black-Box Testing ASP.Net Series">Black-Box Testing ASP.Net Series</a>
                                        </li>
                                        <li>
                                            <a href="/category/dotnet-core" title="DotNet Core">DotNet Core</a>
                                        </li>
                                        <li>
                                            <a href="/category/general" title="General">General</a>
                                        </li>
                                        <li>
                                            <a href="/category/learning" title="Learning">Learning</a>
                                        </li>
                                        <li>
                                            <a href="/category/programming" title="Programming">Programming</a>
                                        </li>
                                        <li>
                                            <a href="/category/seleno" title="Seleno">Seleno</a>
                                        </li>
                                        <li>
                                            <a href="/category/snow" title="Snow">Snow</a>
                                        </li>
                                        <li>
                                            <a href="/category/sql-server" title="SQL Server">SQL Server</a>
                                        </li>
                                        <li>
                                            <a href="/category/test-data" title="Test Data">Test Data</a>
                                        </li>
                                        <li>
                                            <a href="/category/teststack" title="TestStack">TestStack</a>
                                        </li>
                                        <li>
                                            <a href="/category/visual-studio" title="Visual Studio">Visual Studio</a>
                                        </li>
                                </ul>
                            </li>
                            <li><a href="/archive">Archive</a></li>
                            <li><a href="/feed.xml">RSS</a></li>
                        </ul>

                        <div class="navbar-right">
                            <a class="navbar-custom-button" href="https://twitter.com/mjmwhelan" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="/stylesheets/images/twitter.png"></a>
                            <a class="navbar-custom-button" href="https://github.com/mwhelan" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://github.com']);"><img src="/stylesheets/images/github.png"></a>
                            <a class="navbar-custom-button" href="http://www.linkedin.com/in/mwhelan" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://www.linkedin.com']);"><img src="/stylesheets/images/linkedin.png"></a>
                            <a class="navbar-custom-button" href="https://plus.google.com/u/1/105055485720815974241?rel=me" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://plus.google.com']);"><img src="/stylesheets/images/googleplus.png"></a>
                        </div>
                    </div><!--collapse -->
                </div>
            </nav>
        </div><!--row -->
        <!-- row 2: header -->
        <header class="row">
            <a href="/" title="Home"><img width="60" height="60" src="http://www.gravatar.com/avatar/391e4f217a06e3dfc8976a4b99b79617.png" title="logo"></a>
            <h1 class="blog-title">
                <a href="/" title="Michael Whelan" rel="home">Michael Whelan</a>
            </h1>
            <p class="lead blog-description">behaviour driven blog</p>
        </header>

        <!-- row 3: featured -->
        <div class="row">
            
        </div>

        <!-- row 4: body -->
        <div class="row">
            

<div id="post">
    <h1 class="blog-post-title">Testing DateTime</h1>

    <div class="blog-post-meta">
        posted on 20 Oct 2014
            | <a class="label label-primary" href="/category/automated-testing">Automated Testing</a>
    </div>

    <div class="blog-post">
        

        <p>Static methods and properties tend to be difficult to test. You cannot easily mock them, unless you use something like Microsoft Moles. DateTime.Now is a notorious example of a difficult to test static. </p>

<!--excerpt-->

<p>The offending piece of code that inspired me to write this post was a method I was adding to Seleno today. </p>

<pre><code>public void TakeScreenshotAndThrow(string imageName, string errorMessage)
{
    Camera.TakeScreenshot(string.Format(imageName + DateTime.Now().ToString("yyyy-MM-dd_HH-mm-ss") + ".png"));
    throw new SelenoException(errorMessage);
}
</code></pre>

<h2>DateTime Abstraction</h2>

<p>Often  this problem can be solved by abstracting the static away behind an interface and then using dependency injection to inject the implementation of the interface. </p>

<pre><code>public interface ISystemTime
{
    DateTime Now { get; }
}

public class TheSystemTime : ISystemTime
{
    public DateTime Now { get { return DateTime.Now; } }
}

public class SelenoApplication
{
    private ISystemTime _systemTime;
    public SelenoApplication(ISystemTime systemTime)
    {
        _systemTime = systemTime;
    }

    public void TakeScreenshotAndThrow(string imageName, string errorMessage)
    {
        Camera.TakeScreenshot(string.Format(imageName + _systemTime.Now.ToString("yyyy-MM-dd_HH-mm-ss") + ".png"));
        throw new SelenoException(errorMessage);
    }
}
</code></pre>

<p>Then you can easily mock the interface in your tests. I'm using NSubstitute here.</p>

<pre><code>var dateTime = new DateTime(2014, 05, 11, 10, 29, 33);
var systemTime = Substitute.For&lt;ISystemTime&gt;();
systemTime.Now.Returns(dateTime);
</code></pre>

<p>This is the solution that I would normally use to test a static, but DateTime is a bit different. Firstly, the use of DateTime can be quite extensive and you can quickly find you have too many of these interfaces polluting your constructors. Secondly, if you are doing DDD then you don't want to use dependency injection with your domain entities, yet they often need DateTime functions as well. </p>

<h2>SystemTime static class with function</h2>

<p>The solution I like to use is one Ayende <a href="http://ayende.com/blog/3408/dealing-with-time-in-tests">blogged about in 2008</a> where you use a static class with a func as a replacement for the DateTime.Now call.</p>

<pre><code>public static class SystemTime
{
    public static Func&lt;DateTime&gt; Now = () =&gt; DateTime.Now;

    public static void Reset()
    {
        Now = () =&gt; DateTime.Now;
    }
}
</code></pre>

<p>So, now you call <code>SystemTime.Now()</code> instead of <code>DateTime.Now</code>.</p>

<pre><code>public void TakeScreenshotAndThrow(string imageName, string errorMessage)
{
    Camera.TakeScreenshot(string.Format(imageName + SystemTime.Now().ToString("yyyy-MM-dd_HH-mm-ss") + ".png"));
    throw new SelenoException(errorMessage);
}
</code></pre>

<p>And set the value of Now in your test, not forgetting to reset it at the end of the test.</p>

<pre><code>SystemTime.Now = () =&gt; new DateTime(2014, 05, 11, 10, 29, 33);
Action result = () =&gt; _host.Application.TakeScreenshotAndThrow(imageName, errorMessage);
result.ShouldThrow&lt;SelenoException&gt;()
    .WithMessage(errorMessage);
SystemTime.Reset();
</code></pre>

<h2>TestableSystemTime</h2>

<p>One objection to this approach is that the developer might forget to reset the time at the end of the test. Which leads me to the point of this post. Utilising the dispose pattern is a nice way to get around this objection.</p>

<p>I'm not sure where I saw this solution applied to testing DateTime, so apologies if I am not giving credit where it's due. I do remember where I learned about using the dispose pattern in this way - from my good friend Mehdi Khalili in the BDDfy codebase. He used it to <a href="https://github.com/TestStack/TestStack.BDDfy/blob/master/TestStack.BDDfy/Reporters/Html/HtmlReportTag.cs">close HTML tags</a> in the BDDfy HTML Report.</p>

<pre><code>public class TestableSystemTime : IDisposable
{
    public TestableSystemTime(DateTime dateTime)
    {
        SystemTime.Now = () =&gt; dateTime;
    }

    public TestableSystemTime(Func&lt;DateTime&gt; dateTimeFactory)
    {
        SystemTime.Now = dateTimeFactory;
    }

    public void Dispose()
    {
        SystemTime.Reset();
    }
}
</code></pre>

<p>Now we can use it in a using statement in tests and be sure that the <code>Reset</code> method gets called at the end of the using statement when <code>Dispose</code> is called.</p>

<pre><code>using (new TestableSystemTime(dateTime))
{
    Action result = () =&gt; _host.Application.TakeScreenshotAndThrow(imageName, errorMessage);
    result.ShouldThrow&lt;SelenoException&gt;()
        .WithMessage(errorMessage);
}
</code></pre>

<p>Alternatively you can create the date on the fly with the func constructor:</p>

<pre><code>using (new TestableSystemTime(() =&gt; new DateTime(2014, 05, 11, 10, 29, 33)))
</code></pre>

<h2>What about BDD-style tests?</h2>

<p>It's not always desirable to use a using statement. For example, if you are using a BDD-style, which I tend to do, then your statements are broken over multiple methods, and a using statement is not an option. In that case, you can just call the Dispose method at the end of the test yourself, as you can see in the TearDown method in this example:</p>

<pre><code>class When_taking_screenshot : SelenoApplicationSpecification
{
    private string _imageName = "screenshot";
    private string _errorMessage = "there was an error";
    private string _fileName;
    private Exception _result;
    private TestableSystemTime _systemTime

    public override void EstablishContext()
    {
        var dateTime = new DateTime(2014, 05, 11, 10, 29, 33);
        _fileName = string.Format(@"{0}{1}.png", _imageName, dateTime.ToString("yyyy-MM-dd_HH-mm-ss"));
        _systemTime = new TestableSystemTime(dateTime);
    }

    public void Given_initialised_application()
    {
        SUT.Initialize();
    }

    public void When_taking_screenshot_and_throwing()
    {
        _result = Catch.Exception(() =&gt; SUT.TakeScreenshotAndThrow(_imageName, _errorMessage));
    }

    public void Then_should_take_screenshot()
    {
        SubstituteFor&lt;ICamera&gt;().Received().TakeScreenshot(_fileName);
    }

    public void AndThen_should_throw_SelenoException()
    {
        _result.Should().BeOfType&lt;SelenoException&gt;()
            .Which.Message.Should().Be(_errorMessage);
    }

    public override void TearDown()
    {
        _systemTime.Dispose();
    }
}
</code></pre>

    </div>
    
    <div class="blog-post aboutFooter">
        <h3>About Michael Whelan</h3>
        <img style="float:left;padding-right: 1em;" src="http://www.gravatar.com/avatar/391e4f217a06e3dfc8976a4b99b79617.png">
        <p>
            Michael Whelan is a software developer with 20 years’ experience in building (and testing!) applications on the Microsoft stack. He is passionate about applying agile development practices, such as TDD and BDD, to agile processes. Michael specializes in ASP.Net MVC but has also worked with WPF. He does open source development with <a href="http://www.teststack.net/">TestStack</a> to learn from great developers. Michael is a Principal Consultant at <a href="http://www.bjss.com/">BJSS</a> in London.
        </p>
    </div>
    
    <!-- Add this toolbox-->
    <div class="row addThis">
        <div class="addthis_toolbox addthis_default_style row pull-right" style="margin:10px">
            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
            <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
            <a class="addthis_button_linkedin_counter"></a>
            <a class="addthis_counter addthis_pill_style"></a>
        </div>
    </div>
    
    <!-- Disqus Comments -->
    <div class="row">
        <div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://www.michael-whelan.net/testing-date-time/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'givenwhenthen';
    var disqus_url = 'http://www.michael-whelan.net/testing-date-time/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>        
    </div>
    
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53d54a0e28fe9235"></script>

    <!-- Authorship Google -->
    <a style="display: block; width: 30px; height: 30px; text-indent: -999px; text-decoration: none" href="https://plus.google.com/u/1/105055485720815974241?rel=author">Google</a>
</div>

        </div>

        <hr>

        <footer class="row">
            <p>&copy; 2014 - Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a>.</p>
        </footer>
    </div> <!-- /container -->
    <script src="//code.jquery.com/jquery.js"></script>
    <script src="/javascripts/bootstrap.min.js"></script>
    <script src="/javascripts/prettify.js"></script>

    <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-49651944-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>

<script type='text/javascript'>
        $(function () {
            $("pre code").parent().each(function () {
                if (!$(this).hasClass("prettyprint")) {
                    $(this).addClass("prettyprint");
                    a = true
                }
            });

            prettyPrint();
        });
    </script>
    

    
    <!-- Authorship Google -->
    <a style="display: block; width: 30px; height: 30px; text-indent: -999px; text-decoration: none" href="https://plus.google.com/u/1/105055485720815974241?rel=author">Google</a>
</body>
</html>
