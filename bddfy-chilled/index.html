
<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta http-equiv="last-modified" content="2015-01-05T09:03:18.0245930+00:00" />
    <meta name="keywords" content="Automated Testing,BDDfy" />

    <title>Michael Whelan</title>

    <link href="/stylesheets/bootstrap.css" rel="stylesheet">
    <link href="/stylesheets/font-awesome/css/font-awesome.css" rel="stylesheet"/>
    <link rel="stylesheet" href="/stylesheets/github.css" type="text/css">
    <link rel="stylesheet" href="/stylesheets/styles.css" type="text/css" />

    <link rel="canonical" href="http://www.michael-whelan.net/bddfy-chilled/" />
</head>
<body>
    <div class="container">
        <!-- row 1: navigation -->
        <div class="row">
            <nav class="navbar navbar-default navbar-fixed-top navbar-inverse" role="navigation">
                <div class="container">
                    <div class="navbar-header">
                        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#collapse">
                            <span class="sr-only">Toggle navigation</span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </button>
                        <a class="navbar-brand" href="http://michael-whelan.net/">behaviour driven blog</a>
                    </div>
                    <div class="collapse navbar-collapse" id="collapse">
                        <ul class="nav navbar-nav">
                            <li><a href="http://about.me/michaelwhelan">About</a></li>
                            <li class="dropdown">
                                <a href="#" data-toggle="dropdown">Categories <span class="caret"></span></a>
                                <ul class="dropdown-menu">
                                        <li>
                                            <a href="/category/automated-testing" title="Automated Testing">Automated Testing</a>
                                        </li>
                                        <li>
                                            <a href="/category/azure" title="Azure">Azure</a>
                                        </li>
                                        <li>
                                            <a href="/category/bddfy" title="BDDfy">BDDfy</a>
                                        </li>
                                        <li>
                                            <a href="/category/black-box-testing-asp.net-series" title="Black-Box Testing ASP.Net Series">Black-Box Testing ASP.Net Series</a>
                                        </li>
                                        <li>
                                            <a href="/category/general" title="General">General</a>
                                        </li>
                                        <li>
                                            <a href="/category/learning" title="Learning">Learning</a>
                                        </li>
                                        <li>
                                            <a href="/category/programming" title="Programming">Programming</a>
                                        </li>
                                        <li>
                                            <a href="/category/seleno" title="Seleno">Seleno</a>
                                        </li>
                                        <li>
                                            <a href="/category/snow" title="Snow">Snow</a>
                                        </li>
                                        <li>
                                            <a href="/category/sql-server" title="SQL Server">SQL Server</a>
                                        </li>
                                        <li>
                                            <a href="/category/test-data" title="Test Data">Test Data</a>
                                        </li>
                                        <li>
                                            <a href="/category/teststack" title="TestStack">TestStack</a>
                                        </li>
                                        <li>
                                            <a href="/category/visual-studio" title="Visual Studio">Visual Studio</a>
                                        </li>
                                </ul>
                            </li>
                            <li><a href="/archive">Archive</a></li>
                            <li><a href="/feed.xml">RSS</a></li>
                        </ul>

                        <div class="navbar-right">
                            <a class="navbar-custom-button" href="https://twitter.com/mjmwhelan" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://twitter.com']);"><img src="/stylesheets/images/twitter.png"></a>
                            <a class="navbar-custom-button" href="https://github.com/mwhelan" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://github.com']);"><img src="/stylesheets/images/github.png"></a>
                            <a class="navbar-custom-button" href="http://www.linkedin.com/in/mwhelan" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://www.linkedin.com']);"><img src="/stylesheets/images/linkedin.png"></a>
                            <a class="navbar-custom-button" href="https://plus.google.com/u/1/105055485720815974241?rel=me" onclick="javascript:_gaq.push(['_trackEvent','outbound-widget','http://plus.google.com']);"><img src="/stylesheets/images/googleplus.png"></a>
                        </div>
                    </div><!--collapse -->
                </div>
            </nav>
        </div><!--row -->
        <!-- row 2: header -->
        <header class="row">
            <a href="/" title="Home"><img width="60" height="60" src="http://www.gravatar.com/avatar/391e4f217a06e3dfc8976a4b99b79617.png" title="logo"></a>
            <h1 class="blog-title">
                <a href="/" title="Michael Whelan" rel="home">Michael Whelan</a>
            </h1>
            <p class="lead blog-description">behaviour driven blog</p>
        </header>

        <!-- row 3: featured -->
        <div class="row">
            
        </div>

        <!-- row 4: body -->
        <div class="row">
            

<div id="post">
    <h1 class="blog-post-title">BDDfy Chilled</h1>

    <div class="blog-post-meta">
        posted on 31 Oct 2014
            | <a class="label label-primary" href="/category/automated-testing">Automated Testing</a>
            | <a class="label label-primary" href="/category/bddfy">BDDfy</a>
    </div>

    <div class="blog-post">
        

        <p>I like to use BDDfy for unit testing as well as for black-box testing. Unit tests do not have the concept of user stories, but otherwise I like to use the same <code>Given When Then</code> style of testing for all of my tests, and I think that I should have the same quality of reporting for my unit tests as for my acceptance tests. I have my own framework of code that I've built on top of BDDFy that I take from project to project. It gets a little tweaked each time, from NUnit to xUnit, or Moq to NSubstitute, or Castle Windsor to Autofac, depending on the tools each project uses. BDDfy is wonderfully customisable so you are free to make your test framework just they way you want it.</p>

<p>I decided it would make sense to make the mocking/Ioc containers pluggable and publish the library to NuGet. I'm a big fan of Autofac and NSubstitute, and had noticed that Autofac provides automocking container implementations for most of the major mocking frameworks. Then I stumbled on <a href="https://github.com/erwinvandervalk/chill">Chill</a>, and found out that <a href="https://twitter.com/ErwinVanDerValk">Erwin van der Valk</a> was already doing something pretty similar and had done a great job with pluggable mocking containers, with future plans for IoC containers too. Chill is a BDD style testing framework.   </p>

<!--excerpt-->

<blockquote>
  <p>If you stick it in a container, Chill will keep it cool.</p>
</blockquote>

<p>So, I messed around with combining BDDfy with Chill and thought the initial findings were worth sharing. I think this investigation will more than likely be superceded by Chill, as Erwin mentioned he is interested in the possibility of combining BDDfy with Chill. As usual, you can get the code on <a href="https://github.com/mwhelan/BDDfyChilled">GitHub</a>.  </p>

<h2>Specification For</h2>

<p>Chill uses the same <a href="http://xunitpatterns.com/Testcase%20Class%20per%20Fixture.html">testcase class per fixture</a> , inheritance-based, style that I favour, so the first step was just to inherit from the <code>Subject</code> base classes. I need to add a method with the test framework attribute, [Test] for NUnit and [Fact] for xUnit, and call out to BDDFy to run the test. Thankfully, this is the only time I need to do that and all of my test implementation classes do not need any attributes. I would put each of these namespaces in its own library per test framework - I've not managed to find a way around that yet - but I've just combined them here for illustrative purposes.</p>

<pre><code>namespace BDDfyChilled.xUnit
{
    public abstract class SpecificationFor&lt;TSubject&gt; : GivenSubject&lt;TSubject&gt; where TSubject : class
    {
        [Fact]
        public void Run()
        {
            this.BDDfy();
        }
    }

    public abstract class SpecificationFor&lt;TSubject, TResult&gt; : GivenSubject&lt;TSubject, TResult&gt; where TSubject : class
    {
        [Fact]
        public void Run()
        {
            this.BDDfy();
        }
    }
}
namespace BDDfyChilled.NUnit
{
    public abstract class SpecificationFor&lt;TSubject&gt; : GivenSubject&lt;TSubject&gt; where TSubject : class
    {
        [Test]
        public void Run()
        {
            this.BDDfy();
        }
    }
    public abstract class SpecificationFor&lt;TSubject, TResult&gt; : GivenSubject&lt;TSubject, TResult&gt; where TSubject : class
    {
        [Test]
        public void Run()
        {
            this.BDDfy();
        }
    }
}
</code></pre>

<p>Now I can create my test implementation class, combining the best of both worlds of BDDfy and Chill. BDDfy uses reflection to discover and run all of the test methods, and Chill provides all sorts of infrastructure to manage the Subject (or System Under Test), its dependencies, and other test data. Chill is handling the setup (the Givens), the execution (When). <a href="http://www.fluentassertions.com/">Fluent Assertions</a> rounds out the combination by handling the assertions (Thens) for a nice, terse specification. Awesome stuff!</p>

<pre><code>[ChillTestInitializer(typeof(DefaultChillTestInitializer&lt;AutofacNSubstituteChillContainer&gt;))]
public class RetrievingExistingCustomerAsynchronously : SpecificationFor&lt;CustomerController, View&gt;
{
    const int customerId = 12;

    public void Given_an_existing_customer()
    {
        Given(() =&gt;
        {
            The&lt;Customer&gt;()
                .With(x =&gt; x.Id = customerId);

            The&lt;ICustomerStore&gt;()
                .GetCustomerAsync(customerId)
                .Returns(The&lt;Customer&gt;().Asynchronously());
        });
    }

    public void When_retrieving_the_customer_asynchronously()
    {

        When(() =&gt; Subject.GetAsync(customerId));
    }

    public void Then_view_is_returned()
    {
        Result.Should().NotBeNull();
    }

    public void AndThen_model_is_the_existing_custmoer()
    {
        Result.Model.Should().Be(The&lt;Customer&gt;());
    }
}
</code></pre>

<h2>Custom BDDfy Method Name Step Scanner</h2>

<p>Understandably, because Chill and BDDfy are both BDD frameworks, they both use the Given When Then syntax. When I run the test right now I get this error. BDDfy is calling the <code>Given</code>, <code>When</code>, and <code>TheNamed</code> methods on the Chill base class.</p>

<pre><code>Specifications For: CustomerController

Scenario: Retrieving existing customer asynchronously
    Given an existing customer                        [Passed] 
    Given                                             [Failed] [Parameter count mismatch.] [Details at 1 below]
    When retrieving the customer asynchronously       [Not executed] 
    When                                              [Not executed] 
    When                                              [Not executed] 
    Then view is returned                             [Not executed] 
    The named                                         [Not executed] 
      And model is the existing custmoer              [Not executed] 
</code></pre>

<p>We don't want BDDfy to run the Chill methods that conform to its Given When Then pattern. Fortunately, BDDfy allows you to replace the reflection method name step scanner. Here are the key changes - telling BDDfy to ignore the Chill methods named <code>Given</code>, <code>When</code> and <code>TheNamed</code>.</p>

<pre><code>AddMatcher(new MethodNameMatcher(s =&gt; s.StartsWith("Given", StringComparison.OrdinalIgnoreCase) 
    &amp;&amp; s != "Given", ExecutionOrder.SetupState));
AddMatcher(new MethodNameMatcher(s =&gt; s.StartsWith("When", StringComparison.OrdinalIgnoreCase) 
    &amp;&amp; s != "When", ExecutionOrder.Transition));
AddMatcher(new MethodNameMatcher(s =&gt; s.StartsWith("Then", StringComparison.OrdinalIgnoreCase) 
    &amp;&amp; s != "TheNamed", ExecutionOrder.Assertion) { Asserts = true });
</code></pre>

<p>and then tell BDDfy to use the new scanner:</p>

<pre><code>Configurator.Scanners.DefaultMethodNameStepScanner.Disable();
Configurator.Scanners.Add(() =&gt; new ChillMethodNameStepScanner());
</code></pre>

<p>Quite simple really, and now BDDfy and Chill play nicely together.</p>

<p><img src="/images/bddfy-chilled-report.png" alt="BDDfy report" /></p>

<h2>Custom Report</h2>

<p>Because these are just unit tests, and don't have user stories, I've created a custom metadata scanner to display <code>Specifications For: [Subject]</code> (in this case the Subject is the CustomerController), which just uses reflection to grab the name of the Subject type.</p>

<pre><code>public class ChillStoryMetadataScanner : IStoryMetadataScanner
{
    public virtual StoryMetadata Scan(object testObject, Type explicityStoryType = null)
    {
        string specificationTitle = GetSubject(testObject);
        var story = new StoryAttribute() { Title = specificationTitle, TitlePrefix = "Specifications For: " };
        return new StoryMetadata(testObject.GetType(), story);
    }

    private string GetSubject(object testObject)
    {
        return testObject
            .GetType()
            .GetProperty("Subject", BindingFlags.Instance | BindingFlags.NonPublic)
            .PropertyType
            .Name;
    }
}
</code></pre>

<p>I've also created a report configuration to change the header:</p>

<pre><code>public class ChillBDDfyReportConfig : DefaultHtmlReportConfiguration
{
    public override string ReportHeader { get { return "BDDfy Chilled!"; }}
}
</code></pre>

<p>And plugged them both in using the BDDfy Configurator before any of the tests run.</p>

<pre><code>[SetUpFixture]
public class Host
{
    [SetUp]
    public void SetUp()
    {
        Configurator.Scanners.DefaultMethodNameStepScanner.Disable();
        Configurator.Scanners.Add(() =&gt; new ChillMethodNameStepScanner());

        Configurator.Scanners.StoryMetadataScanner = () =&gt; new ChillStoryMetadataScanner();

        Configurator.BatchProcessors.HtmlReport.Disable();
        Configurator.BatchProcessors.Add(new HtmlReporter(new ChillBDDfyReportConfig()));
    }
}
</code></pre>

<h2>Conclusion</h2>

<p>I think BDDfy and Chill are a great combination and I'm looking forward to keeping an eye on the new features that Eriwn is adding to Chill to see more ways that I might be able to use them together. </p>

<p>You can read more about Chill on Erwin's <a href="http://www.erwinvandervalk.net/2014/10/introducing-chill-bdd-style-testing.html">blog</a>. And, of course, you can learn more about <a href="http://teststack.net/">TestStack</a> and our <a href="https://github.com/TestStack/TestStack.BDDfy">BDDfy</a> framework. Finally, you can learn all about Fluent Assertions <a href="http://www.fluentassertions.com/">here</a>.</p>

    </div>
    
    <!-- Add this toolbox-->
    <div class="row addThis">
        <div class="addthis_toolbox addthis_default_style row pull-right" style="margin:10px">
            <a class="addthis_button_facebook_like" fb:like:layout="button_count"></a>
            <a class="addthis_button_tweet"></a>
            <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
            <a class="addthis_button_linkedin_counter"></a>
            <a class="addthis_counter addthis_pill_style"></a>
        </div>
    </div>
    
    <!-- Disqus Comments -->
    <div class="row">
        <div id="disqus_thread"></div>
<script>
    var reset_disqus = function(){
        DISQUS.reset({
            reload: true,
            config: function () {
                //this.page.identifier = '';
                this.page.url = 'http://www.michael-whelan.net/bddfy-chilled/';
                //this.page.title = '';
            }
        });
    };

    var disqus_shortname = 'givenwhenthen';
    var disqus_url = 'http://www.michael-whelan.net/bddfy-chilled/';

    (function() {
        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
    })();

    window.addEventListener('orientationchange', reset_disqus);
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>        
    </div>
    
    <script type="text/javascript" src="//s7.addthis.com/js/300/addthis_widget.js#pubid=ra-53d54a0e28fe9235"></script>

    <!-- Authorship Google -->
    <a style="display: block; width: 30px; height: 30px; text-indent: -999px; text-decoration: none" href="https://plus.google.com/u/1/105055485720815974241?rel=author">Google</a>
</div>

        </div>

        <hr>

        <footer class="row">
            <p>&copy; 2014 - Powered by <a href="https://github.com/Sandra/Sandra.Snow" rel="generator">Sandra.Snow</a>.</p>
        </footer>
    </div> <!-- /container -->
    <script src="//code.jquery.com/jquery.js"></script>
    <script src="/javascripts/bootstrap.min.js"></script>
    <script src="/javascripts/prettify.js"></script>

    <script type="text/javascript">
var _gaq = _gaq || [];

_gaq.push(['_setAccount', 'UA-49651944-1']);
_gaq.push(['_trackPageview']);
        
(function () {
    var ga = document.createElement('script');
    ga.type = 'text/javascript';
    ga.async = true;
    ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
    var s = document.getElementsByTagName('script')[0];
    s.parentNode.insertBefore(ga, s);
})();
</script>

<script type='text/javascript'>
        $(function () {
            $("pre code").parent().each(function () {
                if (!$(this).hasClass("prettyprint")) {
                    $(this).addClass("prettyprint");
                    a = true
                }
            });

            prettyPrint();
        });
    </script>
    

    
    <!-- Authorship Google -->
    <a style="display: block; width: 30px; height: 30px; text-indent: -999px; text-decoration: none" href="https://plus.google.com/u/1/105055485720815974241?rel=author">Google</a>
</body>
</html>
